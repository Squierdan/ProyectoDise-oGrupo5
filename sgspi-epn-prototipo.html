<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SGSPI-EPN - Prototipo</title>
  <style>
    :root{
      --bg:#0f172a; /* slate-900 */
      --panel:#111827; /* gray-900 */
      --muted:#1f2937; /* gray-800 */
      --accent:#22d3ee; /* cyan-400 */
      --accent-2:#06b6d4; /* cyan-500 */
      --text:#e5e7eb; /* gray-200 */
      --text-dim:#94a3b8; /* slate-400 */
      --ok:#10b981; /* emerald-500 */
      --warn:#f59e0b; /* amber-500 */
      --err:#ef4444; /* red-500 */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background:linear-gradient(180deg, #0b1220, #0f172a 50%, #0b1220);
      color:var(--text);
    }
    header{
      display:flex; align-items:center; justify-content:space-between; padding:14px 20px; background:rgba(2,6,23,0.8); border-bottom:1px solid #1f2937; backdrop-filter: blur(6px);
      position:sticky; top:0; z-index:50;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
    }
    .brand .logo{
      width:36px; height:36px; display:grid; place-items:center; border-radius:10px; background:radial-gradient(circle at 30% 30%, var(--accent), #0ea5e9 60%, transparent 61%), linear-gradient(135deg, #0ea5e9, #22d3ee);
      box-shadow:0 0 0 2px rgba(34,211,238,0.25), 0 10px 25px rgba(14,165,233,0.25);
      color:#002b36; font-weight:800;
    }
    .brand h1{font-size:16px; margin:0; letter-spacing:0.4px}
    .brand small{display:block; color:var(--text-dim); font-size:11px}
    nav{display:flex; align-items:center; gap:8px}
    button, .btn{
      background:linear-gradient(180deg, var(--accent), var(--accent-2));
      color:#082f49; border:none; padding:10px 14px; border-radius:10px; font-weight:700; cursor:pointer;
      box-shadow:0 8px 20px rgba(34,211,238,0.25);
    }
    button.ghost{background:transparent; color:var(--text); border:1px solid #334155}
    button.warn{background:linear-gradient(180deg, #fbbf24, #f59e0b); color:#2b1600}
    button.danger{background:linear-gradient(180deg, #f87171, #ef4444); color:#380404}
    button.ok{background:linear-gradient(180deg, #34d399, #10b981); color:#003322}
    button:disabled{opacity:.5; cursor:not-allowed}

    .container{max-width:1200px; margin:24px auto; padding:0 16px}

    .grid{display:grid; gap:16px}
    .grid.cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid.cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    @media (max-width: 980px){.grid.cols-3{grid-template-columns:1fr}.grid.cols-2{grid-template-columns:1fr}}

    .panel{
      background: radial-gradient(1200px 300px at 0% 0%, rgba(34,211,238,0.08), transparent 30%),
                  radial-gradient(1000px 250px at 100% 100%, rgba(14,165,233,0.08), transparent 30%),
                  linear-gradient(180deg, rgba(2,6,23,0.6), rgba(2,6,23,0.4));
      border:1px solid #1f2937; border-radius:14px; padding:16px;
    }
    .panel h2{margin:4px 0 12px 0; font-size:18px}
    .muted{color:var(--text-dim)}
    .row{display:flex; gap:10px; align-items:center}
    .spacer{flex:1}

    label{display:block; font-size:12px; color:var(--text-dim); margin-bottom:6px}
    input, select, textarea{
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid #334155; background:#0b1220; color:var(--text);
      outline:none; transition: border-color .15s ease;
    }
    input:focus, select:focus, textarea:focus{border-color:var(--accent)}

    .card{
      background:linear-gradient(180deg, rgba(2,6,23,0.7), rgba(2,6,23,0.55));
      border:1px solid #1f2937; border-radius:14px; padding:14px;
    }
    .tag{display:inline-block; padding:4px 8px; border-radius:999px; font-size:11px; border:1px solid #334155; color:var(--text-dim)}
    .tag.ok{border-color:#065f46; color:#a7f3d0; background:rgba(16,185,129,0.08)}
    .tag.warn{border-color:#7c2d12; color:#fed7aa; background:rgba(245,158,11,0.08)}
    .tag.err{border-color:#7f1d1d; color:#fecaca; background:rgba(239,68,68,0.08)}

    .progress{height:10px; background:#0b1220; border:1px solid #334155; border-radius:999px; overflow:hidden}
    .progress > div{height:100%; background:linear-gradient(90deg, #34d399, #10b981)}

    table{width:100%; border-collapse:collapse}
    th, td{border-bottom:1px solid #1f2937; padding:8px 6px; text-align:left; font-size:14px}
    th{color:#a5b4fc; font-weight:700}

    .pill-tabs{display:flex; gap:8px; flex-wrap:wrap}
    .pill-tabs button{background:#0b1220; border:1px solid #334155; color:var(--text-dim)}
    .pill-tabs button.active{background:linear-gradient(180deg, rgba(34,211,238,0.15), rgba(14,165,233,0.10)); color:var(--text); border-color:#22d3ee}

    .footer-note{margin-top:24px; color:var(--text-dim); font-size:12px; text-align:center}
    .notice{padding:10px 12px; background:rgba(34,211,238,0.08); border:1px dashed #22d3ee; border-radius:10px; color:#a5f3fc}
    .error{padding:10px 12px; background:rgba(239,68,68,0.08); border:1px dashed #ef4444; border-radius:10px; color:#fecaca}

    .kpi{display:flex; gap:12px; align-items:center}
    .kpi .dot{width:10px; height:10px; border-radius:999px; background:#22d3ee; box-shadow:0 0 10px #22d3ee}

    .list{display:flex; flex-direction:column; gap:8px}
    .small{font-size:12px}

    .hidden{display:none !important}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo">Σ</div>
      <div>
        <h1>SGSPI-EPN</h1>
        <small>Gestión de Ayudantes & Proyectos de Investigación</small>
      </div>
    </div>
    <nav>
      <button id="seedBtn" class="ghost" title="Generar datos de ejemplo">Cargar demo</button>
      <span id="sessionInfo" class="muted"></span>
      <button id="logoutBtn" class="warn hidden">Cerrar sesión</button>
    </nav>
  </header>

  <main class="container">
    <!-- AUTH -->
    <section id="authSection" class="grid cols-2">
      <div class="panel">
        <h2>Inicio de Sesión</h2>
        <div class="muted small">Use correo institucional y contraseña</div>
        <div id="loginError" class="error hidden"></div>
        <div class="grid" style="margin-top:8px">
          <div>
            <label>Correo institucional</label>
            <input id="loginEmail" type="email" placeholder="usuario@epn.edu.ec" />
          </div>
          <div>
            <label>Contraseña</label>
            <input id="loginPassword" type="password" placeholder="••••••••" />
          </div>
          <div class="row">
            <div class="spacer"></div>
            <button id="loginBtn">Ingresar</button>
          </div>
        </div>
      </div>

      <div class="panel">
        <h2>Registro de Estudiantes</h2>
        <div class="muted small">Registro condicionado: solo con invitación/whitelist</div>
        <div id="registerStep1">
          <div class="grid" style="margin-top:8px">
            <div>
              <label>Correo institucional (pre-autorizado)</label>
              <input id="regEmail" type="email" placeholder="nombre.apellido@epn.edu.ec" />
            </div>
            <div class="row">
              <div class="spacer"></div>
              <button id="validateEmailBtn">Validar correo</button>
            </div>
          </div>
          <div id="regValidationMsg" class="notice hidden" style="margin-top:10px"></div>
        </div>
        <div id="registerStep2" class="hidden">
          <div class="grid cols-2" style="margin-top:8px">
            <div>
              <label>Nombres</label>
              <input id="regNombres" type="text" />
            </div>
            <div>
              <label>Apellidos</label>
              <input id="regApellidos" type="text" />
            </div>
            <div>
              <label>Cédula/Pasaporte</label>
              <input id="regDoc" type="text" />
            </div>
            <div>
              <label>Número de Matrícula</label>
              <input id="regMatricula" type="text" />
            </div>
            <div>
              <label>Carrera</label>
              <input id="regCarrera" type="text" />
            </div>
            <div>
              <label>Semestre actual</label>
              <input id="regSemestre" type="text" />
            </div>
            <div>
              <label>Número celular</label>
              <input id="regCelular" type="text" />
            </div>
            <div>
              <label>Definir contraseña</label>
              <input id="regPass" type="password" />
            </div>
          </div>
          <div class="row" style="margin-top:8px">
            <div class="spacer"></div>
            <button id="createAccountBtn" class="ok">Crear cuenta</button>
          </div>
        </div>
      </div>
    </section>

    <!-- DASHBOARD -->
    <section id="dashboardSection" class="hidden">
      <div class="panel">
        <div class="row">
          <h2 id="dashTitle">Dashboard</h2>
          <div class="spacer"></div>
          <div class="pill-tabs" id="roleTabs"></div>
        </div>
        <div id="dashContent" style="margin-top:12px"></div>
      </div>

      <div class="grid cols-3" style="margin-top:16px">
        <div class="panel">
          <h2>Notificaciones (simuladas)</h2>
          <div class="muted small">Envios automáticos: invitaciones, asignaciones, recordatorios 24/48h</div>
          <div id="notifList" class="list" style="margin-top:10px"></div>
        </div>
        <div class="panel">
          <h2>Tareas/Deadlines</h2>
          <div id="deadlineList" class="list"></div>
        </div>
        <div class="panel">
          <h2>Actividad del Sistema</h2>
          <div id="systemActivity" class="list"></div>
        </div>
      </div>

      <div class="footer-note">Prototipo local sin backend. Datos persistidos en localStorage. No usar contraseñas reales.</div>
    </section>
  </main>

  <script>
    // Utilidades
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));
    const uuid = () => crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2)+Date.now();

    const store = {
      get(key, fallback){ try { return JSON.parse(localStorage.getItem(key)) ?? fallback } catch { return fallback } },
      set(key, val){ localStorage.setItem(key, JSON.stringify(val)) },
      push(key, val){ const arr = store.get(key, []); arr.push(val); store.set(key, arr); return arr }
    }

    // Datos base
    const KEYS = {
      users: 'sgspi_users',
      projects: 'sgspi_projects',
      whitelist: 'sgspi_whitelist',
      informes: 'sgspi_informes',
      notifications: 'sgspi_notifications',
      session: 'sgspi_session',
      systemLog: 'sgspi_syslog'
    };

    const roles = {
      estudiante: 'Estudiante',
      docente: 'Docente',
      admin: 'Administrador'
    };

    // Sistema de notificaciones (simulado)
    function notify(toEmail, subject, body, type='info'){
      const n = { id: uuid(), toEmail, subject, body, type, ts: Date.now() };
      store.push(KEYS.notifications, n);
      renderNotifications();
      logSys(`Notificación enviada a ${toEmail}: ${subject}`);
    }

    function logSys(msg){
      const entry = { id: uuid(), msg, ts: Date.now() };
      store.push(KEYS.systemLog, entry);
      renderSysLog();
    }

    // Autenticación
    function currentUser(){ const s = store.get(KEYS.session, null); if(!s) return null; return store.get(KEYS.users, []).find(u=>u.id===s.userId)||null }

    function setSession(user){ if(user){ store.set(KEYS.session, { userId: user.id, ts: Date.now() }); } else { localStorage.removeItem(KEYS.session); } renderSession(); }

    function updateLastLogin(user){ const users = store.get(KEYS.users, []); const idx = users.findIndex(u=>u.id===user.id); if(idx>-1){ users[idx].lastLogin = Date.now(); store.set(KEYS.users, users);} }

    function login(email, password){
      const users = store.get(KEYS.users, []);
      const user = users.find(u => u.email.toLowerCase()===email.toLowerCase() && u.password===password);
      if(!user) throw new Error('Credenciales inválidas');
      setSession(user); updateLastLogin(user);
      logSys(`Inicio de sesión: ${user.email} (${roles[user.role]})`);
      renderAll();
    }

    function logout(){ const u=currentUser(); setSession(null); renderAll(); if(u) logSys(`Cierre de sesión: ${u.email}`) }

    // Registro condicionado (whitelist)
    function isWhitelisted(email){
      const w = store.get(KEYS.whitelist, []);
      return w.find(e => e.email.toLowerCase()===email.toLowerCase());
    }

    function registerStudent({ email, password, profile }){
      const wl = isWhitelisted(email);
      if(!wl) throw new Error('El correo no está pre-autorizado. Solicite invitación al director del proyecto.');
      const users = store.get(KEYS.users, []);
      if(users.some(u=>u.email.toLowerCase()===email.toLowerCase())) throw new Error('Ya existe una cuenta con este correo.');

      const user = {
        id: uuid(), role: 'estudiante', email, password,
        nombres: profile.nombres, apellidos: profile.apellidos, cedula: profile.doc,
        matricula: profile.matricula, carrera: profile.carrera, semestre: profile.semestre,
        celular: profile.celular, lastLogin: null
      };
      users.push(user); store.set(KEYS.users, users);

      // Vincular al proyecto del que proviene la whitelist
      const projects = store.get(KEYS.projects, []);
      const pIdx = projects.findIndex(p=>p.id===wl.projectId);
      if(pIdx>-1){
        if(!projects[pIdx].assistantsIds.includes(user.id)) projects[pIdx].assistantsIds.push(user.id);
        store.set(KEYS.projects, projects);
        notify(email, 'Registro habilitado SGSPI-EPN', `Su registro ha sido habilitado para el proyecto: ${projects[pIdx].name}`,'invite');
      }
      logSys(`Nuevo estudiante registrado: ${email}`);
      return user;
    }

    // Gestión de proyectos e informes
    function createProject({ code, name, faculty, department, directorId }){
      const projects = store.get(KEYS.projects, []);
      if(projects.some(p=>p.code===code)) throw new Error('El código único ya existe');
      const p = { id: uuid(), code, name, faculty, department, directorId, collaboratorsIds: [], assistantsIds: [], periods: [] };
      projects.push(p); store.set(KEYS.projects, projects);
      logSys(`Proyecto creado: ${name} (${code})`);
      const director = store.get(KEYS.users, []).find(u=>u.id===directorId);
      if(director) notify(director.email, 'Proyecto asignado', `Se le ha asignado como Director del proyecto ${name}`,'assign');
      return p;
    }

    function addCollaborator(projectId, docente){
      // docente: {id? optional, email, nombres, apellidos}
      let users = store.get(KEYS.users, []);
      let user = users.find(u=>u.email.toLowerCase()===docente.email.toLowerCase());
      if(!user){
        user = { id: uuid(), role: 'docente', email: docente.email, password: 'temporal', nombres: docente.nombres||'', apellidos: docente.apellidos||'', lastLogin: null };
        users.push(user); store.set(KEYS.users, users);
        notify(user.email, 'Cuenta creada (colaborador)', 'Se ha creado una cuenta temporal. Contraseña: temporal','info');
        logSys(`Docente creado y vinculado: ${user.email}`);
      }
      const projects = store.get(KEYS.projects, []);
      const p = projects.find(p=>p.id===projectId);
      if(!p) throw new Error('Proyecto no encontrado');
      if(!p.collaboratorsIds.includes(user.id)) p.collaboratorsIds.push(user.id);
      store.set(KEYS.projects, projects);
      notify(user.email, 'Vinculación a proyecto', `Ha sido vinculado al proyecto ${p.name}`,'assign');
      return user;
    }

    function inviteStudent(projectId, email, invitedByUserId){
      const wl = store.get(KEYS.whitelist, []);
      if(wl.some(e=>e.email.toLowerCase()===email.toLowerCase() && e.projectId===projectId)) throw new Error('Ya existe invitación activa para este proyecto');
      const entry = { id: uuid(), email, projectId, invitedByUserId, createdAt: Date.now() };
      wl.push(entry); store.set(KEYS.whitelist, wl);
      notify(email, 'Invitación SGSPI-EPN', 'Ha sido invitado a registrarse como ayudante en un proyecto activo.','invite');
      logSys(`Invitación enviada a ${email}`);
      return entry;
    }

    function setPeriod(projectId, { id, name, openDate, closeDate }){
      const projects = store.get(KEYS.projects, []);
      const p = projects.find(p=>p.id===projectId);
      if(!p) throw new Error('Proyecto no encontrado');
      const existingIdx = p.periods.findIndex(x=>x.id===id);
      const period = { id: id||uuid(), name, openDate, closeDate };
      if(existingIdx>-1) p.periods[existingIdx] = period; else p.periods.push(period);
      store.set(KEYS.projects, projects);
      scheduleRemindersForProject(p);
      logSys(`Periodo configurado para ${p.name}: ${name}`);
      return period;
    }

    function submitInforme({ projectId, studentId, periodId, title, fileName }){
      const informes = store.get(KEYS.informes, []);
      const inf = { id: uuid(), projectId, studentId, periodId, title, fileName, status: 'enviado', submittedAt: Date.now(), feedback: '' };
      informes.push(inf); store.set(KEYS.informes, informes);
      const project = store.get(KEYS.projects, []).find(p=>p.id===projectId);
      const director = store.get(KEYS.users, []).find(u=>u.id===project.directorId);
      if(director) notify(director.email, 'Nuevo informe enviado', `Se ha enviado un informe en ${project.name}`,'info');
      logSys(`Informe enviado por ${studentId} en ${projectId}`);
      return inf;
    }

    function reviewInforme(informeId, action, feedback=''){
      const informes = store.get(KEYS.informes, []);
      const idx = informes.findIndex(i=>i.id===informeId);
      if(idx===-1) throw new Error('Informe no encontrado');
      const status = action==='aprobar'?'aprobado':'rechazado';
      informes[idx].status = status; informes[idx].feedback = feedback; store.set(KEYS.informes, informes);
      const student = store.get(KEYS.users, []).find(u=>u.id===informes[idx].studentId);
      if(student) notify(student.email, `Informe ${status}`, `Su informe ha sido ${status}. ${feedback||''}`,'review');
      logSys(`Informe ${informeId} marcado como ${status}`);
    }

    // Recordatorios 24/48h
    function scheduleRemindersForProject(project){
      // Simulación: si closeDate está en las próximas 48h o 24h, envia notificación ahora
      const now = Date.now();
      (project.periods||[]).forEach(per=>{
        const t = new Date(per.closeDate).getTime();
        if(!Number.isFinite(t)) return;
        const delta = t - now;
        const assistants = project.assistantsIds.map(id=>store.get(KEYS.users, []).find(u=>u.id===id)).filter(Boolean);
        if(delta <= 48*3600*1000 && delta > 24*3600*1000){
          assistants.forEach(a=> notify(a.email, 'Recordatorio 48h', `Quedan 48h para subir informe del periodo ${per.name} en ${project.name}`,'reminder'));
        } else if(delta <= 24*3600*1000 && delta > 0){
          assistants.forEach(a=> notify(a.email, 'Recordatorio 24h', `Quedan 24h para subir informe del periodo ${per.name} en ${project.name}`,'reminder'));
        }
      });
    }

    // Render helpers
    function fmtDate(ts){ if(!ts) return '-'; const d = new Date(ts); return d.toLocaleString(); }

    function renderSession(){
      const u = currentUser();
      if(u){
        $('#sessionInfo').textContent = `${u.email} • ${roles[u.role]}`;
        $('#logoutBtn').classList.remove('hidden');
      } else {
        $('#sessionInfo').textContent = '';
        $('#logoutBtn').classList.add('hidden');
      }
    }

    function renderNotifications(){
      const notifs = store.get(KEYS.notifications, []).slice().reverse();
      const box = $('#notifList'); box.innerHTML = '';
      if(!notifs.length){ box.innerHTML = '<div class="muted small">Sin notificaciones</div>'; return; }
      notifs.slice(0,20).forEach(n=>{
        const el = document.createElement('div'); el.className='card';
        el.innerHTML = `<div class="row"><span class="tag">${n.type}</span><div class="spacer"></div><span class="small muted">${fmtDate(n.ts)}</span></div>
                        <div class="small"><b>${n.subject}</b></div>
                        <div class="small muted">Para: ${n.toEmail}</div>
                        <div class="small">${n.body}</div>`;
        box.appendChild(el);
      })
    }

    function renderSysLog(){
      const log = store.get(KEYS.systemLog, []).slice().reverse();
      const box = $('#systemActivity'); box.innerHTML = '';
      if(!log.length){ box.innerHTML = '<div class="muted small">Sin actividad</div>'; return; }
      log.slice(0,20).forEach(l=>{
        const el = document.createElement('div'); el.className='small muted';
        el.textContent = `${fmtDate(l.ts)} — ${l.msg}`;
        box.appendChild(el);
      });
    }

    function renderDeadlines(){
      const u = currentUser(); const box = $('#deadlineList'); box.innerHTML='';
      if(!u){ box.innerHTML = '<div class="muted small">Inicie sesión para ver deadlines</div>'; return; }
      const projects = scopeProjectsForUser(u);
      const upcoming = [];
      projects.forEach(p=> (p.periods||[]).forEach(per=> upcoming.push({ project:p, per })));
      if(!upcoming.length){ box.innerHTML='<div class="muted small">Sin periodos configurados</div>'; return; }
      upcoming.sort((a,b)=> new Date(a.per.closeDate)-new Date(b.per.closeDate));
      upcoming.slice(0,10).forEach(({project, per})=>{
        const rest = new Date(per.closeDate).getTime() - Date.now();
        const days = Math.ceil(rest/86400000);
        const el = document.createElement('div'); el.className='card';
        el.innerHTML = `<div class="row"><div><b>${project.name}</b> — <span class="muted small">${per.name}</span></div><div class="spacer"></div><span class="tag ${days<=0?'err':days<=2?'warn':'ok'}">${days<=0?'vencido':days+' días'}</span></div>
                        <div class="small muted">Cierre: ${per.closeDate||'-'}</div>`;
        box.appendChild(el);
      });
    }

    // Scope de proyectos por rol
    function scopeProjectsForUser(u){
      const projects = store.get(KEYS.projects, []);
      if(u.role==='estudiante') return projects.filter(p=>p.assistantsIds.includes(u.id));
      if(u.role==='docente') return projects.filter(p=> p.directorId===u.id || (p.collaboratorsIds||[]).includes(u.id));
      if(u.role==='admin'){
        // Admin ve todo de su facultad/departamento si tuviera asignado; en demo, si tiene nombres de fac/dept en perfil, filtramos; sino, todo
        const fac = u.faculty||null; const dep = u.department||null;
        return projects.filter(p=> (fac? p.faculty===fac : true) && (dep? p.department===dep : true));
      }
      return [];
    }

    // Dashboards por rol
    function renderDashboard(){
      const u = currentUser();
      if(!u){ $('#dashboardSection').classList.add('hidden'); $('#authSection').classList.remove('hidden'); return; }
      $('#authSection').classList.add('hidden');
      $('#dashboardSection').classList.remove('hidden');
      $('#dashTitle').textContent = `Dashboard — ${roles[u.role]}`;

      // Tabs de rol (si usuario tiene múltiples, en demo dejamos 1)
      const tabs = $('#roleTabs'); tabs.innerHTML = '';
      const tab = document.createElement('button'); tab.className='active'; tab.textContent = roles[u.role]; tabs.appendChild(tab);

      const content = $('#dashContent');
      if(u.role==='estudiante') renderStudent(content, u);
      if(u.role==='docente') renderTeacher(content, u);
      if(u.role==='admin') renderAdmin(content, u);

      renderDeadlines();
    }

    function renderStudent(container, user){
      const projects = scopeProjectsForUser(user);
      container.innerHTML = `
        <div class="grid cols-2">
          <div class="card">
            <div class="row"><h3>Mis Proyectos</h3><div class="spacer"></div><span class="tag">${projects.length} activos</span></div>
            <div id="studentProjects"></div>
          </div>
          <div class="card">
            <h3>Subir Informe</h3>
            <div class="grid">
              <div>
                <label>Proyecto</label>
                <select id="stProjectSel"></select>
              </div>
              <div>
                <label>Periodo</label>
                <select id="stPeriodSel"></select>
              </div>
              <div>
                <label>Título del informe</label>
                <input id="stTitle" type="text" placeholder="Informe de actividades" />
              </div>
              <div>
                <label>Archivo (simulado)</label>
                <input id="stFile" type="text" placeholder="nombre-archivo.pdf / docx" />
              </div>
              <div class="row">
                <div class="spacer"></div>
                <button id="stSubmitBtn" class="ok">Enviar</button>
              </div>
            </div>
          </div>
        </div>
        <div class="card" style="margin-top:12px">
          <h3>Mis Informes</h3>
          <table>
            <thead><tr><th>Proyecto</th><th>Periodo</th><th>Título</th><th>Archivo</th><th>Estado</th><th>Enviado</th></tr></thead>
            <tbody id="stInformesTable"></tbody>
          </table>
        </div>
      `;

      // Proyectos list y métricas
      const list = $('#studentProjects'); list.innerHTML='';
      projects.forEach(p=>{
        // métricas sencillas: informes entregados vs total de periodos
        const periods = p.periods||[];
        const informes = store.get(KEYS.informes, []).filter(i=>i.projectId===p.id && i.studentId===user.id);
        const total = periods.length || 1; // evitar div/0
        const done = informes.length;
        const pct = Math.min(100, Math.round((done/total)*100));
        const card = document.createElement('div'); card.className='panel';
        card.innerHTML = `<div class="row"><div><b>${p.name}</b> <span class="muted small">(${p.code})</span></div><div class="spacer"></div><span class="tag">${p.faculty} / ${p.department}</span></div>
                          <div class="small muted">Director: ${(store.get(KEYS.users, []).find(u=>u.id===p.directorId)||{}).email||'-'}</div>
                          <div class="small">Progreso — Informes ${done}/${total}</div>
                          <div class="progress" title="${pct}%"><div style="width:${pct}%"></div></div>`;
        list.appendChild(card);
      });

      // Selects proyecto/periodo
      const prSel = $('#stProjectSel'); const peSel = $('#stPeriodSel');
      prSel.innerHTML = projects.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
      function refreshPeriods(){
        const pid = prSel.value; const p = projects.find(x=>x.id===pid);
        const options = (p?.periods||[]).map(per=>`<option value="${per.id}">${per.name} — cierre ${per.closeDate||'-'}</option>`).join('');
        peSel.innerHTML = options;
      }
      prSel.addEventListener('change', refreshPeriods); refreshPeriods();

      $('#stSubmitBtn').onclick = ()=>{
        const projectId = prSel.value; const periodId = peSel.value; const title = $('#stTitle').value.trim(); const fileName = $('#stFile').value.trim();
        if(!projectId||!periodId||!title||!fileName){ alert('Complete todos los campos'); return; }
        submitInforme({ projectId, studentId: user.id, periodId, title, fileName });
        renderDashboard();
      }

      // Tabla de informes
      const stBody = $('#stInformesTable');
      const informes = store.get(KEYS.informes, []).filter(i=> i.studentId===user.id);
      stBody.innerHTML = informes.map(i=>{
        const p = store.get(KEYS.projects, []).find(x=>x.id===i.projectId); const per = (p?.periods||[]).find(pe=>pe.id===i.periodId);
        const cls = i.status==='aprobado'?'ok': i.status==='rechazado'?'err':'warn';
        return `<tr><td>${p?.name||'-'}</td><td>${per?.name||'-'}</td><td>${i.title}</td><td>${i.fileName}</td><td><span class="tag ${cls}">${i.status}</span></td><td>${fmtDate(i.submittedAt)}</td></tr>`;
      }).join('');
    }

    function renderTeacher(container, user){
      const projects = scopeProjectsForUser(user);
      container.innerHTML = `
        <div class="grid cols-3">
          <div class="card">
            <h3>Mis Proyectos</h3>
            <div id="tcProjects"></div>
          </div>
          <div class="card">
            <h3>Invitar Estudiante</h3>
            <div class="grid">
              <div>
                <label>Proyecto</label>
                <select id="tcProjectInvite"></select>
              </div>
              <div>
                <label>Correo institucional</label>
                <input id="tcInviteEmail" type="email" placeholder="estudiante@epn.edu.ec" />
              </div>
              <div class="row"><div class="spacer"></div><button id="tcInviteBtn">Invitar</button></div>
              <div id="tcInviteMsg" class="notice hidden"></div>
            </div>
          </div>
          <div class="card">
            <h3>Configurar Periodos</h3>
            <div class="grid">
              <div>
                <label>Proyecto</label>
                <select id="tcProjectPeriod"></select>
              </div>
              <div>
                <label>Nombre del periodo</label>
                <input id="tcPerName" type="text" placeholder="Corte 1" />
              </div>
              <div>
                <label>Apertura</label>
                <input id="tcPerOpen" type="datetime-local" />
              </div>
              <div>
                <label>Cierre</label>
                <input id="tcPerClose" type="datetime-local" />
              </div>
              <div class="row"><div class="spacer"></div><button id="tcPerSave" class="ok">Guardar Periodo</button></div>
            </div>
          </div>
        </div>
        <div class="card" style="margin-top:12px">
          <h3>Revisi��n de Informes</h3>
          <table>
            <thead><tr><th>Proyecto</th><th>Estudiante</th><th>Periodo</th><th>Título</th><th>Archivo</th><th>Estado</th><th>Acciones</th></tr></thead>
            <tbody id="tcInformes"></tbody>
          </table>
        </div>
      `;

      // Mis proyectos
      const box = $('#tcProjects');
      projects.forEach(p=>{
        const el = document.createElement('div'); el.className='panel';
        const assistants = p.assistantsIds.map(id=> store.get(KEYS.users, []).find(u=>u.id===id)?.email || '—');
        el.innerHTML = `<div class="row"><div><b>${p.name}</b> <span class="muted small">(${p.code})</span></div><div class="spacer"></div><span class="tag">${assistants.length} ayudantes</span></div>
                        <div class="small muted">Colaboradores: ${(p.collaboratorsIds||[]).map(id=> store.get(KEYS.users, []).find(u=>u.id===id)?.email).filter(Boolean).join(', ')||'—'}</div>
                        <div class="small">Ayudantes: ${assistants.join(', ')||'—'}</div>`;
        box.appendChild(el);
      });

      // Selects proyecto
      const prSel1 = $('#tcProjectInvite'); prSel1.innerHTML = projects.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
      const prSel2 = $('#tcProjectPeriod'); prSel2.innerHTML = projects.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');

      $('#tcInviteBtn').onclick = ()=>{
        const email = $('#tcInviteEmail').value.trim(); const pid = prSel1.value;
        if(!email){ alert('Ingrese un correo'); return; }
        try{ inviteStudent(pid, email, user.id); const msg=$('#tcInviteMsg'); msg.textContent='Invitación enviada'; msg.classList.remove('hidden'); setTimeout(()=>msg.classList.add('hidden'), 2500); }
        catch(e){ alert(e.message) }
      };

      $('#tcPerSave').onclick = ()=>{
        const pid = prSel2.value; const name = $('#tcPerName').value.trim(); const open = $('#tcPerOpen').value; const close = $('#tcPerClose').value;
        if(!pid||!name||!open||!close){ alert('Complete todos los campos'); return; }
        try{ setPeriod(pid, { id:null, name, openDate:open, closeDate:close }); renderDashboard(); }
        catch(e){ alert(e.message) }
      };

      // Informes pendientes
      const informes = store.get(KEYS.informes, []).filter(i=> projects.some(p=>p.id===i.projectId));
      const tbody = $('#tcInformes');
      tbody.innerHTML = informes.map(i=>{
        const p = projects.find(pp=>pp.id===i.projectId);
        const per = (p?.periods||[]).find(pe=>pe.id===i.periodId);
        const st = store.get(KEYS.users, []).find(u=>u.id===i.studentId);
        return `<tr>
          <td>${p?.name||'-'}</td><td>${st?.email||'-'}</td><td>${per?.name||'-'}</td>
          <td>${i.title}</td><td>${i.fileName}</td><td><span class="tag ${i.status==='aprobado'?'ok':i.status==='rechazado'?'err':'warn'}">${i.status}</span></td>
          <td class="row">
            <button data-act="ok" data-id="${i.id}" class="ok">Aprobar</button>
            <button data-act="no" data-id="${i.id}" class="danger">Rechazar</button>
          </td>
        </tr>`;
      }).join('');

      tbody.querySelectorAll('button').forEach(btn=>{
        btn.onclick = ()=>{
          const id = btn.getAttribute('data-id'); const act = btn.getAttribute('data-act');
          const fb = act==='no' ? prompt('Motivo/feedback:','Corregir secciones 2 y 3') : '';
          reviewInforme(id, act==='ok'?'aprobar':'rechazar', fb||''); renderDashboard();
        }
      });
    }

    function renderAdmin(container, user){
      const projects = scopeProjectsForUser(user);
      container.innerHTML = `
        <div class="grid cols-3">
          <div class="card">
            <h3>Crear Proyecto</h3>
            <div class="grid">
              <div>
                <label>Código único</label>
                <input id="adCode" type="text" placeholder="P-2026-001" />
              </div>
              <div>
                <label>Nombre</label>
                <input id="adName" type="text" placeholder="Proyecto de Investigación X" />
              </div>
              <div>
                <label>Facultad</label>
                <input id="adFac" type="text" placeholder="FIS" />
              </div>
              <div>
                <label>Departamento</label>
                <input id="adDep" type="text" placeholder="Ciencias de la Computación" />
              </div>
              <div>
                <label>Director (correo)</label>
                <input id="adDirEmail" type="email" placeholder="docente@epn.edu.ec" />
              </div>
              <div class="row"><div class="spacer"></div><button id="adCreate" class="ok">Crear</button></div>
            </div>
          </div>
          <div class="card">
            <h3>Vincular Docente a Proyecto</h3>
            <div class="grid">
              <div>
                <label>Proyecto</label>
                <select id="adLinkProject"></select>
              </div>
              <div>
                <label>Correo del Docente</label>
                <input id="adLinkEmail" type="email" placeholder="docente2@epn.edu.ec" />
              </div>
              <div class="row"><div class="spacer"></div><button id="adLink" class="">Vincular</button></div>
            </div>
          </div>
          <div class="card">
            <h3>Buscar Proyectos</h3>
            <div class="grid">
              <div>
                <label>Término</label>
                <input id="adSearch" type="text" placeholder="Nombre, código, director, estudiante" />
              </div>
              <div class="row"><div class="spacer"></div><button id="adSearchBtn" class="ghost">Buscar</button></div>
            </div>
          </div>
        </div>

        <div class="grid cols-2" style="margin-top:12px">
          <div class="card">
            <h3>Resultados</h3>
            <table>
              <thead><tr><th>Código</th><th>Proyecto</th><th>Director</th><th>Ayudantes</th></tr></thead>
              <tbody id="adResults"></tbody>
            </table>
          </div>
          <div class="card">
            <h3>Monitoreo y Auditoría</h3>
            <table>
              <thead><tr><th>Usuario</th><th>Rol</th><th>Última conexión</th></tr></thead>
              <tbody id="adAudit"></tbody>
            </table>
          </div>
        </div>
      `;

      const prSel = $('#adLinkProject'); prSel.innerHTML = projects.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');

      $('#adCreate').onclick = ()=>{
        const code=$('#adCode').value.trim(); const name=$('#adName').value.trim(); const fac=$('#adFac').value.trim(); const dep=$('#adDep').value.trim(); const dirEmail=$('#adDirEmail').value.trim();
        if(!code||!name||!fac||!dep||!dirEmail){ alert('Complete todos los campos'); return; }
        // Asegurar director
        let users = store.get(KEYS.users, []);
        let dir = users.find(u=>u.email.toLowerCase()===dirEmail.toLowerCase());
        if(!dir){ dir = { id: uuid(), role:'docente', email: dirEmail, password:'temporal', nombres:'', apellidos:'', lastLogin:null }; users.push(dir); store.set(KEYS.users, users); notify(dir.email,'Cuenta creada (director)','Se ha creado una cuenta temporal. Contraseña: temporal','info'); }
        try{ createProject({ code, name, faculty: fac, department: dep, directorId: dir.id }); renderDashboard(); alert('Proyecto creado'); }
        catch(e){ alert(e.message) }
      };

      $('#adLink').onclick = ()=>{
        const pid = prSel.value; const email = $('#adLinkEmail').value.trim(); if(!pid||!email){ alert('Complete los campos'); return; }
        try{ addCollaborator(pid, { email }); renderDashboard(); alert('Docente vinculado'); }
        catch(e){ alert(e.message) }
      };

      $('#adSearchBtn').onclick = ()=> renderAdminResults($('#adSearch').value.trim());
      renderAdminResults('');

      // Auditor��a
      const users = store.get(KEYS.users, []);
      const auditBody = $('#adAudit');
      auditBody.innerHTML = users.map(u=> `<tr><td>${u.email}</td><td>${roles[u.role]}</td><td>${u.lastLogin?fmtDate(u.lastLogin):'-'}</td></tr>`).join('');
    }

    function renderAdminResults(term){
      const projects = store.get(KEYS.projects, []);
      const users = store.get(KEYS.users, []);
      const informes = store.get(KEYS.informes, []);
      const resBody = $('#adResults');
      const t = term.toLowerCase();
      const results = projects.filter(p=>{
        const director = users.find(u=>u.id===p.directorId);
        const assistants = p.assistantsIds.map(id=> users.find(u=>u.id===id)?.email || '');
        const match = !t || p.name.toLowerCase().includes(t) || p.code.toLowerCase().includes(t) || (director?.email||'').toLowerCase().includes(t) || assistants.some(a=>a.toLowerCase().includes(t));
        return match;
      });
      resBody.innerHTML = results.map(p=>{
        const director = users.find(u=>u.id===p.directorId);
        const assistants = p.assistantsIds.map(id=> users.find(u=>u.id===id)?.email || '').filter(Boolean);
        return `<tr><td>${p.code}</td><td>${p.name}</td><td>${director?.email||'-'}</td><td>${assistants.join(', ')||'—'}</td></tr>`;
      }).join('');
    }

    // Flujo UI principal
    function renderAll(){ renderSession(); const u=currentUser(); if(u){ $('#authSection').classList.add('hidden'); $('#dashboardSection').classList.remove('hidden'); } else { $('#authSection').classList.remove('hidden'); $('#dashboardSection').classList.add('hidden'); } renderDashboard(); renderNotifications(); renderSysLog(); }

    // Seed demo
    function seedDemo(){
      if(confirm('Esto reemplazará los datos actuales del prototipo con datos de ejemplo. ¿Continuar?')){
        localStorage.removeItem(KEYS.users);
        localStorage.removeItem(KEYS.projects);
        localStorage.removeItem(KEYS.whitelist);
        localStorage.removeItem(KEYS.informes);
        localStorage.removeItem(KEYS.notifications);
        localStorage.removeItem(KEYS.systemLog);
        localStorage.removeItem(KEYS.session);

        const admin = { id: uuid(), role:'admin', email:'admin@epn.edu.ec', password:'admin', nombres:'Admin', apellidos:'EPN', faculty:'FIS', department:'Ciencias de la Computación', lastLogin:null };
        const docente = { id: uuid(), role:'docente', email:'director@epn.edu.ec', password:'director', nombres:'Docente', apellidos:'EPN', lastLogin:null };
        const est = { id: uuid(), role:'estudiante', email:'estudiante@epn.edu.ec', password:'estudiante', nombres:'Ana', apellidos:'Perez', cedula:'0102030405', matricula:'A001', carrera:'Sistemas', semestre:'6', celular:'0999999999', lastLogin:null };
        store.set(KEYS.users, [admin,docente,est]);

        const project = { id: uuid(), code:'P-2026-001', name:'Plataforma IA aplicada', faculty:'FIS', department:'Ciencias de la Computación', directorId: docente.id, collaboratorsIds: [], assistantsIds: [est.id], periods: [] };
        const now = new Date(); const plus2d = new Date(now.getTime()+2*24*3600*1000); const plus4d = new Date(now.getTime()+4*24*3600*1000);
        project.periods.push({ id: uuid(), name:'Corte 1', openDate: now.toISOString().slice(0,16), closeDate: plus2d.toISOString().slice(0,16) });
        project.periods.push({ id: uuid(), name:'Corte 2', openDate: now.toISOString().slice(0,16), closeDate: plus4d.toISOString().slice(0,16) });
        store.set(KEYS.projects, [project]);

        // Informe de ejemplo
        const inf = { id: uuid(), projectId: project.id, studentId: est.id, periodId: project.periods[0].id, title:'Informe Inicial', fileName:'informe1.pdf', status:'enviado', submittedAt: Date.now(), feedback:'' };
        store.set(KEYS.informes, [inf]);

        // Whitelist de ejemplo
        store.set(KEYS.whitelist, [{ id: uuid(), email:'nuevo.est@epn.edu.ec', projectId: project.id, invitedByUserId: docente.id, createdAt: Date.now() }]);

        notify(est.email,'Asignación a proyecto','Has sido asignado al proyecto Plataforma IA aplicada','assign');
        logSys('Datos de ejemplo cargados');
        renderAll();
        alert('Datos de ejemplo cargados. Puede iniciar sesión como:\n- admin@epn.edu.ec / admin\n- director@epn.edu.ec / director\n- estudiante@epn.edu.ec / estudiante');
      }
    }

    // Eventos UI
    $('#seedBtn').onclick = seedDemo;
    $('#logoutBtn').onclick = logout;
    $('#loginBtn').onclick = ()=>{
      const email=$('#loginEmail').value.trim(); const pass=$('#loginPassword').value;
      try{ login(email, pass); $('#loginError').classList.add('hidden'); }
      catch(e){ const box=$('#loginError'); box.textContent = e.message; box.classList.remove('hidden'); }
    };

    $('#validateEmailBtn').onclick = ()=>{
      const email = $('#regEmail').value.trim();
      const box = $('#regValidationMsg');
      const wl = isWhitelisted(email);
      if(wl){
        box.textContent = 'Correo validado. Complete sus datos para crear la cuenta.';
        box.classList.remove('hidden');
        $('#registerStep2').classList.remove('hidden');
      } else {
        box.textContent = 'Este correo no ha sido pre-autorizado. Solicite invitación a su director (Docente).';
        box.classList.remove('hidden');
        $('#registerStep2').classList.add('hidden');
      }
    };

    $('#createAccountBtn').onclick = ()=>{
      const email = $('#regEmail').value.trim();
      const profile = {
        nombres: $('#regNombres').value.trim(), apellidos: $('#regApellidos').value.trim(), doc: $('#regDoc').value.trim(),
        matricula: $('#regMatricula').value.trim(), carrera: $('#regCarrera').value.trim(), semestre: $('#regSemestre').value.trim(), celular: $('#regCelular').value.trim()
      };
      const pass = $('#regPass').value;
      try{
        const user = registerStudent({ email, password: pass, profile });
        setSession(user); renderAll(); alert('Cuenta creada y sesión iniciada.');
      }catch(e){ alert(e.message) }
    };

    // Inicio
    renderAll();
  </script>
</body>
</html>